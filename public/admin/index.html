<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="noindex" />
    <title>Henry Koon Thinks â€” Admin</title>
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <style>
      .category-badge {
        display: inline-block;
        padding: 2px 10px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-left: 8px;
        vertical-align: middle;
      }
      .category-badge.life { background: #dbeafe; color: #1e40af; }
      .category-badge.faith { background: #fef3c7; color: #92400e; }
      .category-badge.essays { background: #e0e7ff; color: #3730a3; }
      .category-badge.the-outdoors { background: #dcfce7; color: #166534; }
      .category-badge.poetry { background: #fce7f3; color: #9d174d; }
      .category-badge.reviews { background: #f5f3ff; color: #6b21a8; }
      .post-date-line {
        display: block;
        font-size: 12px;
        color: #9ca3af;
        margin-top: 2px;
      }
      /* Prevent flash during CMS load */
      #nc-root {
        opacity: 0;
        animation: fadeIn 0.3s ease-in forwards;
        animation-delay: 1s;
      }
      @keyframes fadeIn {
        to { opacity: 1; }
      }
    </style>
  </head>
  <body>
    <script src="https://unpkg.com/decap-cms@3.1.10/dist/decap-cms.js"></script>
    <script>
      // Decap CMS renders the summary as plain text inside list cards.
      // This script watches for those cards and reformats them.
      const categoryColors = {
        life: 'life',
        faith: 'faith',
        essays: 'essays',
        'the-outdoors': 'the-outdoors',
        poetry: 'poetry',
        reviews: 'reviews',
      };

      function formatCards() {
        // Find all card elements that contain our summary format
        const cards = document.querySelectorAll('a[href*="/collections/posts/entries/"]');
        cards.forEach(card => {
          if (card.dataset.formatted) return;
          
          // Find the element with the summary text
          const allText = card.textContent || '';
          // Match: Title - [category]\ndate  OR  Title - [category] - date
          const match = allText.match(/^(.+?)\s*-\s*\[([^\]]+)\][\s\n-]*(\d{4}-\d{2}-\d{2}.*)$/);
          if (!match) return;

          const title = match[1].trim();
          const category = match[2].trim();
          const date = match[3].trim();

          // Find the deepest text node or span that holds the summary
          const walker = document.createTreeWalker(card, NodeFilter.SHOW_TEXT, null, false);
          let textNode;
          let summaryNode = null;
          while (textNode = walker.nextNode()) {
            if (textNode.textContent.includes(title) && textNode.textContent.includes('[')) {
              summaryNode = textNode;
              break;
            }
          }

          if (summaryNode) {
            const parent = summaryNode.parentNode;
            const wrapper = document.createElement('span');
            
            // Title
            const titleSpan = document.createElement('span');
            titleSpan.textContent = title;
            titleSpan.style.fontWeight = '600';
            titleSpan.style.color = '#111827';
            wrapper.appendChild(titleSpan);

            // Category badge
            const badge = document.createElement('span');
            badge.className = 'category-badge ' + (categoryColors[category] || '');
            badge.textContent = category.replace('-', ' ');
            wrapper.appendChild(badge);

            // Date on new line
            const dateLine = document.createElement('span');
            dateLine.className = 'post-date-line';
            dateLine.textContent = date;
            wrapper.appendChild(dateLine);

            parent.replaceChild(wrapper, summaryNode);
            card.dataset.formatted = 'true';
          }
        });
      }

      // Run periodically since Decap CMS renders dynamically
      setInterval(formatCards, 1000);
    </script>
  </body>
</html>
